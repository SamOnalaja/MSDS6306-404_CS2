---
title: "Case Study 2"
author: "Mai Loan Tran, Zackary Gill"
date: "November 27, 2018"
output: html_document
---

```{r}
library(caret)
library(MASS)
library(lattice)
library(ggplot2)
library(dplyr)

#Reads in the files
df <- read.csv("csv/CaseStudy2-data.csv")
testset <- read.csv("csv/CaseStudy2Validation.csv")

#Sets the reference level to 'No' so that it is predicting 'Yes'
df$Attrition <- relevel(df$Attrition, ref = "No")
testset$Attrition <- relevel(testset$Attrition, ref = "No")

#Creates the prediction and sets the values to Yes/No
predictyn <- function(fit, test)
{
  p1 <- ifelse(predict(fit, test, type="response") > 0.5, "Yes", "No")
  p1
}

#-------------Plotting everything to see the correlation between pairs of variables within the data set-------------
pairs(df[,c(3,2,4:8)])
pairs(df[,c(3,9:16)])
pairs(df[,c(3,17:23)])
pairs(df[,c(3,24:30)])
pairs(df[,c(3,31:37)])

#--------------------All of the variable names------------
#Age + BusinessTravel + DailyRate + Department + DistanceFromHome + Education + EducationField + EmployeeCount + EnvironmentSatisfaction + Gender + HourlyRate + JobInvolvement + JobLevel + JobRole + JobSatisfaction + MaritalStatus + MonthlyIncome + MonthlyRate + NumCompaniesWorked + OverTime + PercentSalaryHike + PerformanceRating + RelationshipSatisfaction + StandardHours + StockOptionLevel + TotalWorkingYears + TrainingTimesLastYear + WorkLifeBalance + YearsAtCompany + YearsInCurrentRole + YearsSinceLastPromotion + YearsWithCurrManager

#Determined the following variables to be unnecessary in the model:
#ID, EmployeeNumber, Over18, Rand, StandardHours, EmployeeCount

#dfc is the cleaned data (gets rid of variable with only 1 level)
dfc <- df
dfc$Over18 <- NULL

#-------------Cross Validation------------------
set.seed(1)
train_perc <- 0.5
samplesize <- length(dfc$Attrition)
train_indices = sample(seq(1, samplesize,length = samplesize), train_perc*samplesize)
dfc.train <- dfc[train_indices,]
dfc.test <- dfc[-train_indices,]

#Automatically selecting explanatory variables
full.model <- glm(Attrition~., data = dfc.train, family="binomial")

#Stepwise
step.model <- stepAIC(full.model, direction = c("both"), trace=FALSE)

#Backward
back.model <- stepAIC(full.model, direction = c("backward"), trace=FALSE)

#Forward
forw.model <- stepAIC(full.model, direction = c("forward"), trace=FALSE)

#Custom Attrition w/Acc 87.52137
#cust.model <- glm(Attrition~BusinessTravel + DistanceFromHome + EnvironmentSatisfaction + JobInvolvement + JobSatisfaction + MaritalStatus + NumCompaniesWorked + OverTime + TotalWorkingYears + WorkLifeBalance + YearsInCurrentRole + YearsSinceLastPromotion, data = dfc.train, family="binomial")

#Custom Attrition w/Acc 88.55
cust.model <- glm(Attrition~BusinessTravel + Department + DistanceFromHome + EnvironmentSatisfaction + JobInvolvement + JobRole + JobSatisfaction + MaritalStatus + NumCompaniesWorked + OverTime + RelationshipSatisfaction + YearsAtCompany + YearsSinceLastPromotion, data = dfc.train, family="binomial")

#Tests the models
#'WARNING: prediction from a rank-deficient fit may be misleading' suggest that we have too many explanatory variables
pred.cust <- as.vector(predictyn(cust.model, dfc.test))
pred.step <- as.vector(predictyn(step.model, dfc.test))
pred.back <- as.vector(predictyn(back.model, dfc.test))
pred.forw <- as.vector(predictyn(forw.model, dfc.test))

#Creates the confusion matrix with all those stats
cust.mat <- confusionMatrix(table(dfc.test$Attrition, pred.cust))
step.mat <- confusionMatrix(table(dfc.test$Attrition, pred.step))
back.mat <- confusionMatrix(table(dfc.test$Attrition, pred.back))
forw.mat <- confusionMatrix(table(dfc.test$Attrition, pred.forw))

cust.mat
step.mat
back.mat
forw.mat

#Prints out just the overall accuracy % of the models
acc <- as.data.frame(cbind(cust.mat$overall[1]*100, step.mat$overall[1]*100, back.mat$overall[1]*100, forw.mat$overall[1]*100))
names(acc) <- c("Custom", "Stepwise", "Backward", "Forward")
acc

#---------------TODO: Choose the best prediction--------------
write.csv(pred.cust, "Case2Predictions.csv")

#Create function to calculate the amount into a percentage and process the transformation to a table and back
makereadyforplot <- function(df)
{
  df1 <- table(df)
  df2 <- df1
  for(i in c(1:length(df1[,1])))
  {
    for(j in c(1:4))
    {
      df2[i,j] <- round(100*df1[i,j]/(df1[i,1]+df1[i,2]+df1[i,3]+df1[i,4]),0)
    }
  }
  
  as.data.frame(df2)
}

#-------------------EVERYTHING BELOW HERE IS FOR MAKING THE HISTOGRAMS--------------------
#Gets only the rows we want and make sure they are always in the same order
dfc.js <- dfc[,c("JobRole","JobSatisfaction")]
dfc2 <- makereadyforplot(dfc.js)

#Plot Job Satisifaction by Role
ggplot(data = dfc2, aes(x = factor(JobRole), y=Freq, group=JobSatisfaction, fill = JobSatisfaction)) +
  geom_bar(stat = "identity", position = "dodge") +
  xlab("Job Role") +
  ylab("Percent") +
  geom_text(size=3, aes(label= paste(Freq,"%",sep="")), position=position_dodge(width=.95)) +
  scale_fill_brewer(palette = "Set1") + 
  ggtitle("Job Satisfaction by Role") +
  theme(legend.position="top",plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 90))

#Plot Environment Satisfaction by Role
dfc.es <- dfc[,c("JobRole","EnvironmentSatisfaction")]
dfc3 <- makereadyforplot(dfc.es)

ggplot(data = dfc3, aes(x = factor(JobRole), y=Freq, group=EnvironmentSatisfaction, fill = EnvironmentSatisfaction)) +
  geom_bar(stat = "identity", position = "dodge") +
  xlab("Job Role") +
  ylab("Percent") +
  geom_text(size=3, aes(label= paste(Freq,"%",sep="")), position=position_dodge(width=.95)) +
  scale_fill_brewer(palette = "Set2") + 
  ggtitle("Environment Satisfaction by Role") +
  theme(legend.position="top",plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 90))

#Plot Relationship Satisfaction by Role
dfc.rs <- dfc[,c("JobRole","RelationshipSatisfaction")]
dfc4 <- makereadyforplot(dfc.rs)

ggplot(data = dfc4, aes(x = factor(JobRole), y=Freq, group=RelationshipSatisfaction, fill = RelationshipSatisfaction)) +
  geom_bar(stat = "identity", position = "dodge") +
  xlab("Job Role") +
  ylab("Percent") +
  geom_text(size=3, aes(label= paste(Freq,"%",sep="")), position=position_dodge(width=.95)) +
  scale_fill_brewer(palette = "Set3") + 
  ggtitle("Relationship Satisfaction by Role") +
  theme(legend.position="top",plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 90))

#Plot Work Life Balance by Role
dfc.wlb <- dfc[,c("JobRole","WorkLifeBalance")]
dfc5 <- makereadyforplot(dfc.wlb)

ggplot(data = dfc5, aes(x = factor(JobRole), y=Freq, group=WorkLifeBalance, fill = WorkLifeBalance)) +
  geom_bar(stat = "identity", position = "dodge") +
  xlab("Job Role") +
  ylab("Percent") +
  geom_text(size=3, aes(label= paste(Freq,"%",sep="")), position=position_dodge(width=.95)) +
  scale_fill_brewer(palette = "Set1") + 
  ggtitle("Work Life Balance by Role") +
  theme(legend.position="top",plot.title = element_text(hjust = 0.5),axis.text.x = element_text(angle = 90))

```
